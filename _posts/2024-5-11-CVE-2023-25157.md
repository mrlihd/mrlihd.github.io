---
layout: post
title: Má»™t cÃ¡ch tiáº¿p cáº­n khÃ¡c cá»§a CVE-2023-25157
categories: cve-research
---

# Má»Ÿ Ä‘áº§u

VÃ o má»™t ngÃ y Ä‘áº¹p trá»i giá»¯a thÃ¡ng 6/2023, mÃ¬nh tÃ¬nh cá» lÆ°á»›t Twitter vÃ  Ä‘á»c Ä‘Æ°á»£c lá»— há»•ng má»›i trÃªn GeoServer vá»«a Ä‘Æ°á»£c cÃ´ng bá»‘ PoC. ÄÃ¢y lÃ  má»™t lá»— há»•ng SQL Injection cÃ³ mÃ£ CVE-2023-25157 vá»›i rate khÃ¡ cao (CVSS: 9.8/10). Ngon rá»“i ğŸ˜, Ä‘Ãºng lÃºc team mÃ¬nh Ä‘ang nháº­n nhiá»u project cÃ³ khoáº£ng chá»¥c con GeoServer. Qua má»™t há»“i tÃ¬m kiáº¿m, mÃ¬nh tháº¥y cÃ³ sáºµn PoC trÃªn github táº¡i [https://github.com/win3zz/CVE-2023-25157](https://github.com/win3zz/CVE-2023-25157), mÃ¡u Script Kiddie cá»§a mÃ¬nh láº¡i ná»•i lÃªn ğŸ•µï¸â€â™€ï¸ vÃ  mang ra test thá»­ luÃ´n mÃ  khÃ´ng thÃ¨m Ä‘á»c docs vÃ  káº¿t quáº£ lÃ  â€¦

Bingo, trÃºng mÃ¡nh rá»“i, giá» lÃ  lÃºc hÃ³a náº¯c cÆ¡ Ä‘i cháº¡y script kháº¯p nÆ¡i thÃ´i

![error-based-request.PNG](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/error-based-request.png)

NhÆ°ng Ä‘á»i khÃ´ng nhÆ° mÆ¡, sau má»™t há»“i spray and pray thÃ¬ chá»‰ cÃ³ target Ä‘áº§u tiÃªn cÅ©ng lÃ  target duy nháº¥t cÃ³ thá»ƒ reproduce Ä‘Æ°á»£c bug, táº¥t cáº£ cÃ²n láº¡i Ä‘á»u tráº£ lá»i not vulnerable. Vá»›i táº¥t cáº£ target Ä‘á»u cÃ³ version tháº¥p hÆ¡n báº£n patch, mÃ¬nh tháº¥y váº«n cÃ²n chÃºt hy vá»ng gÃ¬ Ä‘Ã³ nÃªn quyáº¿t Ä‘á»‹nh tÃ¬m hiá»ƒu sÃ¢u hÆ¡n vá» bug nÃ y.

# ÄÃ o sÃ¢u hÆ¡n vÃ o CVE advisory vÃ  GeoServer Documents

Sau khi ngá»“i Ä‘á»c vá» [thÃ´ng bÃ¡o](https://geoserver.org/vulnerability/2023/02/20/ogc-filter-injection.html) cá»§a GeoServer, mÃ¬nh phÃ¡t hiá»‡n ngoÃ i cÃ¡ch inject vÃ o truy váº¥n CQL qua function `strStartsWith` thÃ¬ cÃ²n cÃ¡c vector khai thÃ¡c, cá»¥ thá»ƒ:

![advisory.PNG](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/advisory.png)

Qua Ä‘Ã¡nh giÃ¡ thÃ¬ mÃ¬nh tháº¥y vector sá»­ dá»¥ng filter `PropertyIsLike` cÃ³ nhiá»u Ä‘iá»u kiá»‡n khai thÃ¡c nháº¥t bá»Ÿi:

1. Giá»‘ng `strStartsWith` náº¿u sá»­ dá»¥ng tÃ­nh nÄƒng DataStore cá»§a PostGIS vá»›i chá»©c nÄƒng encode Ä‘Æ°á»£c enable
2. TrÆ°á»ng há»£p dÃ¹ng vá»›i má»™t trÆ°á»ng dáº¡ng `String` thÃ¬ cÃ³ thá»ƒ khai thÃ¡c vá»›i má»i RDBMS 

KhÃ´ng giá»‘ng nhÆ° `strStartsWith`  sá»­ dá»¥ng OGC Common Query Language (CQL) cÃ³ thá»ƒ inject truy váº¥n SQL vÃ o ngay param trong GET request. Filter `PropertyIsLike` Ä‘Æ°á»£c dÃ¹ng trong OGC Filter expression language, má»™t dáº¡ng truy váº¥n dá»¯ liá»‡u trong GeoServer sá»­ dá»¥ng Ä‘á»‹nh dáº¡ng XML Ä‘á»ƒ truyá»n dá»¯ liá»‡u. 

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled.png)

# Dá»±ng mÃ´i trÆ°á»ng thá»­ nghiá»‡m

MÃ¬nh lá»±a chá»n dá»±ng lab báº±ng docker theo image cá»§a vulhub trÃªn dockerhub, vá»«a nhanh gá»n láº¡i dá»… dá»n dáº¹p ğŸ˜

CÃ¡c bÆ°á»›c thá»±c hiá»‡n ráº¥t Ä‘Æ¡n giáº£n, chá»‰ cáº§n láº§n lÆ°á»£t táº£i 2 file `startup.sh` vÃ  `docker-compose.yml` tá»« repo sau vá» cÃ¹ng 1 folder:

[](https://github.com/vulhub/vulhub/tree/master/geoserver/CVE-2023-25157)

Cháº¡y command `docker compose up -d` Ä‘á»ƒ tá»± Ä‘á»™ng pull cÃ¡c image cáº§n thiáº¿t vá» vÃ  khá»Ÿi táº¡o containers.

 Giáº£i thÃ­ch `docker-compose.yml`:

```yaml
version: '3'
services:
 web:
   image: vulhub/geoserver:2.22.1
   depends_on:
    - postgres
   ports:
    - "8080:8080"
   volumes:
     - ./startup.sh:/startup.sh
   command: bash /startup.sh
 postgres:
   image: postgis/postgis:14-3.3-alpine
   environment: 
    - POSTGRES_PASSWORD=vulhub
    - POSTGRES_DB=geoserver
```

- Sá»­ dá»¥ng DB postgis, geoserver version 2.22.1
- Webapp cháº¡y trÃªn port 8080 bind tá»›i port 8080 cá»§a host
- Copy script `startup.sh` vÃ o container Ä‘á»ƒ khá»Ÿi táº¡o dá»¯ liá»‡u máº«u

Káº¿t quáº£, táº¡o thÃ nh cÃ´ng mÃ´i trÆ°á»ng test vá»›i tÃ i khoáº£n Ä‘Äƒng nháº­p: admin/geoserver

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%201.png)

VÃ¬ Ä‘ang test lá»— há»•ng SQLi, nÃªn chÃºng ta cáº§n biáº¿t vá»›i má»—i payload gá»­i lÃªn, á»©ng dá»¥ng sáº½ thá»±c thi cÃ¢u SQL query nÃ o, vÃ¬ váº­y mÃ¬nh chá»n cÃ¡ch log láº¡i toÃ n bá»™ cÃ¡c SQL query. YÃªu cáº§u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n báº±ng cÃ¡ch thay Ä‘á»•i config trong container PostgreSQL (tham kháº£o post â€¦)

# HoÃ n thiá»‡n Payload má»›i

Ok, mÃ´i trÆ°á»ng lab Ä‘Ã£ sáºµn sÃ ng, giá» mÃ¬nh sáº½ thá»­ test cÃ¡c payload SQLi Ä‘á»ƒ kiá»ƒm tra cÃ¡ch xá»­ lÃ½ cá»§a á»©ng dá»¥ng. CÃ¡ch filter dá»¯ liá»‡u nÃ y sá»­ dá»¥ng user input trong tháº» <ogc:Literal> nÃªn Ä‘Ã¢y sáº½ lÃ  nÆ¡i mÃ¬nh test payload.

Äáº§u tiÃªn sáº½ lÃ  test escape quote.

```xml
<ogc:Literal>
	a'
</ogc:Literal>
```

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%202.png)

Káº¿t quáº£ tráº£ vá» khÃ´ng cÃ³ nhiá»u thÃ´ng tin, nÃªn mÃ¬nh sáº½ check log postgresql Ä‘á»ƒ xem cÃ¢u query Ä‘Æ°á»£c thá»±c hiá»‡n lÃ  gÃ¬

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%203.png)

MÃ¬nh tháº¥y 1 nhÃ¡y Ä‘Æ¡n (single quote) trong request Ä‘Ã£ Ä‘Æ°á»£c escape thÃ nh 2 nhÃ¡y Ä‘Æ¡n (â€™â€™). TÃ¬nh huá»‘ng nÃ y ráº¥t giá»‘ng trong má»™t sá»‘ bÃ i CTF Ä‘Ã£ gáº·p khi á»©ng dá»¥ng tá»± escape single quote báº±ng cÃ¡ch thÃªm 1 single quote ná»¯a ngay cáº¡nh nÃ³. Giáº£ thiáº¿t mÃ¬nh Ä‘áº·t ra Ä‘á»ƒ bypass lÃ  chÃ¨n payload `\â€™`  vá»›i kÃ¬ vá»ng náº¿u á»©ng dá»¥ng khÃ´ng escape dáº¥u `\` thÃ¬ payload sáº½ chuyá»ƒn thÃ nh `\â€™â€™` , Ä‘á»“ng nghÄ©a vá»›i viá»‡c `\â€™` sáº½ trá»Ÿ thÃ nh literal `â€˜` vÃ  Ä‘á»ƒ láº¡i 1 dáº¥u `â€˜` á»Ÿ cuá»‘i Ä‘á»ƒ escape SQL query.

Payload test: `*\â€™ and 1=1` 

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%204.png)

NhÆ° á»Ÿ bÃªn pháº£i hÃ¬nh, cÃ³ váº» nhÆ° ta Ä‘Ã£ escape thÃ nh cÃ´ng SQL query vÃ  trigger má»™t SQL Exception. VÃ¬ á»©ng dá»¥ng tráº£ vá» thÃ´ng tin chi tiáº¿t cá»§a exception, mÃ¬nh sáº½ thá»­ trigger Error-based SQLi Ä‘á»ƒ láº¥y thÃ´ng tin DB version:

Payload: `â€˜\) and 1=(select cast(version() as numeric)) â€” -`

Káº¿t quáº£ thÃ nh cÃ´ng láº¥y Ä‘Æ°á»£c data tá»« DB

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%205.png)

### Káº¿t luáº­n

Trong blog nÃ y mÃ¬nh Ä‘Ã£ giá»›i thiá»‡u má»™t cÃ¡ch tiáº¿p cáº­n má»›i Ä‘á»‘i vá»›i GeoServer Ä‘á»ƒ khai thÃ¡c CVE-2023-25157 vÃ  hÆ°á»›ng dáº«n dá»±ng láº¡i mÃ´i trÆ°á»ng thá»­ nghiá»‡m. Hy vá»ng thÃ´ng tin nÃ y sáº½ giÃºp Ã­ch cho cÃ¡c báº¡n trong quÃ¡ trÃ¬nh pentest vÃ  nghiÃªn cá»©u cÃ¡c lá»— há»•ng tÆ°Æ¡ng tá»±. 

CÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o PoC mÃ  mÃ¬nh Ä‘Ã£ custom láº¡i tá»« repo cá»§a tÃ¡c giáº£ win3zz theo hÆ°á»›ng exploit cá»§a mÃ¬nh táº¡i Ä‘Ã¢y â€¦

Má»i thÃ´ng tin trong blog Ä‘á»u vÃ¬ má»¥c Ä‘Ã­ch nghiÃªn cá»©u, tÃ¡c giáº£ khÃ´ng chá»‹u trÃ¡ch nhiá»‡m vá»›i má»i hÃ nh vi láº¡m dá»¥ng Ä‘á»ƒ vi pháº¡m phÃ¡p luáº­t.

Best regards.
