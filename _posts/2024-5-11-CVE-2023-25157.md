---
layout: post
title: Một cách tiếp cận khác của CVE-2023-25157
categories: cve-research
---

# Mở đầu

Vào một ngày đẹp trời giữa tháng 6/2023, mình tình cờ lướt Twitter và đọc được lỗ hổng mới trên GeoServer vừa được công bố PoC. Đây là một lỗ hổng SQL Injection có mã CVE-2023-25157 với rate khá cao (CVSS: 9.8/10). Ngon rồi 😎, đúng lúc team mình đang nhận nhiều project có khoảng chục con GeoServer. Qua một hồi tìm kiếm, mình thấy có sẵn PoC trên github tại [https://github.com/win3zz/CVE-2023-25157](https://github.com/win3zz/CVE-2023-25157), máu Script Kiddie của mình lại nổi lên 🕵️‍♀️ và mang ra test thử luôn mà không thèm đọc docs và kết quả là …

Bingo, trúng mánh rồi, giờ là lúc hóa nắc cơ đi chạy script khắp nơi thôi

![error-based-request.PNG](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/error-based-request.png)

Nhưng đời không như mơ, sau một hồi spray and pray thì chỉ có target đầu tiên cũng là target duy nhất có thể reproduce được bug, tất cả còn lại đều trả lời not vulnerable. Với tất cả target đều có version thấp hơn bản patch, mình thấy vẫn còn chút hy vọng gì đó nên quyết định tìm hiểu sâu hơn về bug này.

# Đào sâu hơn vào CVE advisory và GeoServer Documents

Sau khi ngồi đọc về [thông báo](https://geoserver.org/vulnerability/2023/02/20/ogc-filter-injection.html) của GeoServer, mình phát hiện ngoài cách inject vào truy vấn CQL qua function `strStartsWith` thì còn các vector khai thác, cụ thể:

![advisory.PNG](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/advisory.png)

Qua đánh giá thì mình thấy vector sử dụng filter `PropertyIsLike` có nhiều điều kiện khai thác nhất bởi:

1. Giống `strStartsWith` nếu sử dụng tính năng DataStore của PostGIS với chức năng encode được enable
2. Trường hợp dùng với một trường dạng `String` thì có thể khai thác với mọi RDBMS 

Không giống như `strStartsWith`  sử dụng OGC Common Query Language (CQL) có thể inject truy vấn SQL vào ngay param trong GET request. Filter `PropertyIsLike` được dùng trong OGC Filter expression language, một dạng truy vấn dữ liệu trong GeoServer sử dụng định dạng XML để truyền dữ liệu. 

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled.png)

# Dựng môi trường thử nghiệm

Mình lựa chọn dựng lab bằng docker theo image của vulhub trên dockerhub, vừa nhanh gọn lại dễ dọn dẹp 😎

Các bước thực hiện rất đơn giản, chỉ cần lần lượt tải 2 file `startup.sh` và `docker-compose.yml` từ repo sau về cùng 1 folder:

[](https://github.com/vulhub/vulhub/tree/master/geoserver/CVE-2023-25157)

Chạy command `docker compose up -d` để tự động pull các image cần thiết về và khởi tạo containers.

 Giải thích `docker-compose.yml`:

```yaml
version: '3'
services:
 web:
   image: vulhub/geoserver:2.22.1
   depends_on:
    - postgres
   ports:
    - "8080:8080"
   volumes:
     - ./startup.sh:/startup.sh
   command: bash /startup.sh
 postgres:
   image: postgis/postgis:14-3.3-alpine
   environment: 
    - POSTGRES_PASSWORD=vulhub
    - POSTGRES_DB=geoserver
```

- Sử dụng DB postgis, geoserver version 2.22.1
- Webapp chạy trên port 8080 bind tới port 8080 của host
- Copy script `startup.sh` vào container để khởi tạo dữ liệu mẫu

Kết quả, tạo thành công môi trường test với tài khoản đăng nhập: admin/geoserver

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%201.png)

Vì đang test lỗ hổng SQLi, nên chúng ta cần biết với mỗi payload gửi lên, ứng dụng sẽ thực thi câu SQL query nào, vì vậy mình chọn cách log lại toàn bộ các SQL query. Yêu cầu này có thể được thực hiện bằng cách thay đổi config trong container PostgreSQL (tham khảo post …)

# Hoàn thiện Payload mới

Ok, môi trường lab đã sẵn sàng, giờ mình sẽ thử test các payload SQLi để kiểm tra cách xử lý của ứng dụng. Cách filter dữ liệu này sử dụng user input trong thẻ <ogc:Literal> nên đây sẽ là nơi mình test payload.

Đầu tiên sẽ là test escape quote.

```xml
<ogc:Literal>
	a'
</ogc:Literal>
```

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%202.png)

Kết quả trả về không có nhiều thông tin, nên mình sẽ check log postgresql để xem câu query được thực hiện là gì

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%203.png)

Mình thấy 1 nháy đơn (single quote) trong request đã được escape thành 2 nháy đơn (’’). Tình huống này rất giống trong một số bài CTF đã gặp khi ứng dụng tự escape single quote bằng cách thêm 1 single quote nữa ngay cạnh nó. Giả thiết mình đặt ra để bypass là chèn payload `\’`  với kì vọng nếu ứng dụng không escape dấu `\` thì payload sẽ chuyển thành `\’’` , đồng nghĩa với việc `\’` sẽ trở thành literal `‘` và để lại 1 dấu `‘` ở cuối để escape SQL query.

Payload test: `*\’ and 1=1` 

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%204.png)

Như ở bên phải hình, có vẻ như ta đã escape thành công SQL query và trigger một SQL Exception. Vì ứng dụng trả về thông tin chi tiết của exception, mình sẽ thử trigger Error-based SQLi để lấy thông tin DB version:

Payload: `‘\) and 1=(select cast(version() as numeric)) — -`

Kết quả thành công lấy được data từ DB

![Untitled](../images/GeoServer%20CVE-2023-25157%20A%20different%20proof%20of%20conc%2069d48eda72354da4a31784843f78b656/Untitled%205.png)

### Kết luận

Trong blog này mình đã giới thiệu một cách tiếp cận mới đối với GeoServer để khai thác CVE-2023-25157 và hướng dẫn dựng lại môi trường thử nghiệm. Hy vọng thông tin này sẽ giúp ích cho các bạn trong quá trình pentest và nghiên cứu các lỗ hổng tương tự. 

Các bạn có thể tham khảo PoC mà mình đã custom lại từ repo của tác giả win3zz theo hướng exploit của mình tại đây …

Mọi thông tin trong blog đều vì mục đích nghiên cứu, tác giả không chịu trách nhiệm với mọi hành vi lạm dụng để vi phạm pháp luật.

Best regards.
